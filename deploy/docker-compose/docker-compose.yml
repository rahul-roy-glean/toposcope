# ---------------------------------------------------------
# Hosted deployment stack for Toposcope.
#
# Usage:
#   cp .env.example .env   # then edit .env
#   docker compose up -d
# ---------------------------------------------------------

services:
  # --- PostgreSQL ------------------------------------------
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: toposcope
      POSTGRES_USER: toposcope
      POSTGRES_PASSWORD: ${DB_PASSWORD:-toposcope}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U toposcope"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- API server (Go) ------------------------------------
  api:
    build:
      context: ../..
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://toposcope:${DB_PASSWORD:-toposcope}@postgres:5432/toposcope?sslmode=disable
      AUTO_MIGRATE: "true"
      API_KEY: ${API_KEY:-}
      AUTH_MODE: ${AUTH_MODE:-api-key}
      STORAGE_BACKEND: ${STORAGE_BACKEND:-local}
      LOCAL_STORAGE_PATH: /data
      S3_BUCKET: ${S3_BUCKET:-}
      S3_REGION: ${S3_REGION:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      GCS_BUCKET: ${GCS_BUCKET:-}
    volumes:
      - apidata:/data

  # --- Web UI (Next.js) -----------------------------------
  web:
    build:
      context: ../../web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_MODE: hosted
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8080}
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - api

  # --- OAuth2 Proxy (optional OIDC auth) ------------------
  # Uncomment to enable OIDC authentication via OAuth2 Proxy.
  #
  # oauth2-proxy:
  #   image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
  #   restart: unless-stopped
  #   ports:
  #     - "4180:4180"
  #   environment:
  #     OAUTH2_PROXY_PROVIDER: oidc
  #     OAUTH2_PROXY_OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
  #     OAUTH2_PROXY_CLIENT_ID: ${OIDC_CLIENT_ID}
  #     OAUTH2_PROXY_CLIENT_SECRET: ${OIDC_CLIENT_SECRET}
  #     OAUTH2_PROXY_COOKIE_SECRET: ${COOKIE_SECRET}
  #     OAUTH2_PROXY_EMAIL_DOMAINS: "*"
  #     OAUTH2_PROXY_UPSTREAM: http://api:8080
  #     OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
  #     OAUTH2_PROXY_PASS_USER_HEADERS: "true"
  #     OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
  #   depends_on:
  #     - api

volumes:
  pgdata:
  apidata:
